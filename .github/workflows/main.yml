name: Build Zen Browser Portable

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Find and Download Zip
      shell: powershell
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $url = "https://api.github.com/repos/zen-browser/desktop/releases/tags/twilight"
        $headers = @{ "Authorization" = "token $env:GH_TOKEN" }
        try {
            $release = Invoke-RestMethod -Uri $url -Method Get -Headers $headers
        } catch {
            Write-Error "API Error: $($_.Exception.Message)"
            exit 1
        }

        $downloadUrl = ""
        $tagVersion = $release.tag_name  # "twilight"
        $displayName = $release.name     # e.g., "Twilight build - 1.19t (2026-01-26 at 23:09:04)"

        # Parse build version like "1.19t"
        if ($displayName -match '(\d+\.\d+[a-z]?)') {
            $buildVer = $matches[1]
        } else {
            $buildVer = "0.0"  # Fallback
        }

        # Make safe package version (e.g., "1.19.0.0")
        $safeVer = $buildVer -replace '[a-z]', ''
        while (($safeVer.ToCharArray() | Where-Object { $_ -eq '.' }).Count -lt 3) { $safeVer += ".0" }
        if ($safeVer.StartsWith('.')) { $safeVer = "0" + $safeVer }

        foreach ($asset in $release.assets) {
            if ($asset.name -eq "zen.win-x86_64.zip") {  # Exact name for x64; use "zen.win-arm64.zip" for ARM
                $downloadUrl = $asset.browser_download_url
                break
            }
        }

        if (-not $downloadUrl) {
            Write-Error "Target Not Found - checked for zen.win-x86_64.zip"
            exit 1
        }

        Write-Host "Target tag: $tagVersion, Build: $buildVer, Safe package version: $safeVer"
        Invoke-WebRequest -Uri $downloadUrl -OutFile "zen.zip"

        echo "VERSION=$tagVersion" >> $env:GITHUB_ENV
        echo "PACKAGE_VERSION=$safeVer" >> $env:GITHUB_ENV
        echo "DISPLAY_VERSION=$displayName" >> $env:GITHUB_ENV
    
    - name: Extract Zip
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "ZenBrowserPortable\App\ZenBrowser"
        New-Item -ItemType Directory -Force -Path "ZenBrowserPortable\App\AppInfo"
        New-Item -ItemType Directory -Force -Path "ZenBrowserPortable\Data"
        New-Item -ItemType Directory -Force -Path "ZenBrowserPortable\Other\Source"

        # Extract to a temporary folder to inspect structure
        Expand-Archive -Path "zen.zip" -DestinationPath "temp_extract" -Force

        # Handle the common extra 'zen' subfolder in Twilight ZIPs
        $sourcePath = "temp_extract"
        if (Test-Path "temp_extract\zen") {
            Write-Host "Extra 'zen' folder detected - moving contents up"
            $sourcePath = "temp_extract\zen"
        }

        # Move everything to the expected location
        Move-Item -Path "$sourcePath\*" -Destination "ZenBrowserPortable\App\ZenBrowser" -Force
        # Handle hidden files if any
        Move-Item -Path "$sourcePath\.*" -Destination "ZenBrowserPortable\App\ZenBrowser" -Force -ErrorAction SilentlyContinue

        # Clean up
        Remove-Item -Path "temp_extract" -Recurse -Force -ErrorAction SilentlyContinue
        # Clean up
        Remove-Item -Path "temp_extract" -Recurse -Force -ErrorAction SilentlyContinue
    
    - name: Configure App
      shell: powershell
      run: |
        # Disable updates via policies
        $distDir = "ZenBrowserPortable\App\ZenBrowser\distribution"
        New-Item -ItemType Directory -Force -Path $distDir
        Set-Content -Path "$distDir\policies.json" -Value '{ "policies": { "DisableAppUpdate": true, "ManualAppUpdateOnly": true } }'

        # Write version files
        $ver = $env:VERSION
        $packageVer = $env:PACKAGE_VERSION
        $displayVer = $env:DISPLAY_VERSION

        Set-Content -Path "ZenBrowserPortable\App\AppInfo\version.txt" -Value $displayVer

        # Handle appinfo.ini (from your repo's template)
        $iniPath = "ZenBrowserPortable\App\AppInfo\appinfo.ini"
        $content = Get-Content "appinfo.ini" -Raw

        $content = $content -replace "PackageVersion=1.0.0.0", "PackageVersion=$packageVer"
        $content = $content -replace "DisplayVersion=Latest", "DisplayVersion=$displayVer"

        # Append CommercialUse if missing (more reliable than placeholder replace)
        if ($content -notmatch '\[License\].*CommercialUse=true') {
            $content += "`r`n`r`n[License]`r`nCommercialUse=true"
        }

        Set-Content -Path $iniPath -Value $content -Encoding UTF8

    - name: Create Help File
      shell: powershell
      run: |
        Set-Content -Path "ZenBrowserPortable\help.html" -Value "<html><body><h1>Zen Browser Portable (Twilight)</h1><p>Built from Zen Twilight release.</p></body></html>"

    - name: Compile Launcher
      shell: cmd
      run: |
        copy appicon.ico ZenBrowserPortable\App\AppInfo\
        set CSC=%windir%\Microsoft.NET\Framework64\v4.0.30319\csc.exe
        "%CSC%" /target:exe /out:ZenBrowserPortable\ZenBrowserPortable.exe /win32icon:appicon.ico /r:System.Windows.Forms.dll Launcher.cs

    - name: Generate PAF Icons
      shell: powershell
      run: |
        Add-Type -AssemblyName System.Drawing
        $icoPath = "appicon.ico"
        $destDir = "ZenBrowserPortable\App\AppInfo"
        if (-not (Test-Path $icoPath)) { Write-Error "appicon.ico missing!"; exit 1 }
        $icon = [System.Drawing.Icon]::ExtractAssociatedIcon($icoPath)
        $bmp = $icon.ToBitmap()
        foreach ($size in 16, 32, 128) {
            $resized = new-object System.Drawing.Bitmap($bmp, $size, $size)
            $resized.Save("$destDir\appicon_$size.png", [System.Drawing.Imaging.ImageFormat]::Png)
        }
        Copy-Item $icoPath "$destDir\appicon.ico" -Force

    - name: Package to ZIP
      shell: powershell
      run: |
        $displayVer = $env:DISPLAY_VERSION -replace '[^a-zA-Z0-9.-]', '_'  # Safe for filename
        $zipName = "ZenBrowserPortable_Twilight_${displayVer}.zip"

        Write-Host "Creating ZIP: $zipName"
        Compress-Archive -Path "ZenBrowserPortable" -DestinationPath $zipName -Force

    - name: Upload Release
      uses: softprops/action-gh-release@v2  # Updated to v2 for better reliability
      with:
        tag_name: ${{ env.VERSION }}
        name: Zen Browser Portable ${{ env.VERSION }}
        files: ZenBrowserPortable_Twilight_*.zip
        overwrite: true  # Overwrite existing release assets if needed
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
