name: Build Zen Browser Portable

on:
  schedule:
    - cron: '0 6 * * *' # 06:00 UTC daily
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find and Download Zip
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $url = "https://api.github.com/repos/zen-browser/desktop/releases/tags/twilight"
          $headers = @{ "Authorization" = "token $env:GH_TOKEN" }
          try {
              $release = Invoke-RestMethod -Uri $url -Method Get -Headers $headers
          } catch {
              Write-Error "API Error: $($_.Exception.Message)"
              exit 1
          }
          $downloadUrl = ""
          $tagVersion = $release.tag_name
          $displayName = $release.name
          if ($displayName -match '(\d+\.\d+[a-z]?)') {
              $buildVer = $matches[1]
          } else {
              $buildVer = "0.0"
          }
          $safeVer = $buildVer -replace '[a-z]', ''
          while (($safeVer.ToCharArray() | Where-Object { $_ -eq '.' }).Count -lt 3) { $safeVer += ".0" }
          if ($safeVer.StartsWith('.')) { $safeVer = "0" + $safeVer }
          foreach ($asset in $release.assets) {
              if ($asset.name -eq "zen.win-x86_64.zip") {
                  $downloadUrl = $asset.browser_download_url
                  break
              }
          }
          if (-not $downloadUrl) {
              Write-Error "Target Not Found - checked for zen.win-x86_64.zip"
              exit 1
          }
          Write-Host "Target tag: $tagVersion, Build: $buildVer, Safe package version: $safeVer"
          Invoke-WebRequest -Uri $downloadUrl -OutFile "zen.zip
