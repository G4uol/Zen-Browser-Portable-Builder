name: Build Zen Browser Portable

on:
  schedule:
    - cron: '0 6 * * *'   # 06:00 UTC daily
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find and Download Zip
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Cache-busting query param to force fresh API response
          $cacheBuster = Get-Random
          $url = "https://api.github.com/repos/zen-browser/desktop/releases/tags/twilight?_=$cacheBuster"
          $headers = @{
              "Authorization" = "token $env:GH_TOKEN"
              "Cache-Control" = "no-cache, no-store, must-revalidate"
              "Pragma" = "no-cache"
              "Expires" = "0"
          }

          try {
              $release = Invoke-RestMethod -Uri $url -Method Get -Headers $headers -UseBasicParsing
          } catch {
              Write-Error "API Error: $($_.Exception.Message)"
              exit 1
          }

          $downloadUrl = ""
          $tagVersion = $release.tag_name
          $displayName = $release.name
          $upstreamUpdated = $release.updated_at

          # More precise: use asset updated_at for change detection
          $assetUpdated = ""
          foreach ($asset in $release.assets) {
              if ($asset.name -eq "zen.win-x86_64.zip") {
                  $downloadUrl = $asset.browser_download_url
                  $assetUpdated = $asset.updated_at
                  break
              }
          }

          if (-not $downloadUrl) {
              Write-Error "Target Not Found - checked for zen.win-x86_64.zip"
              exit 1
          }

          Write-Host "Target tag: $tagVersion"
          Write-Host "Display name: $displayName"
          Write-Host "Release updated_at: $upstreamUpdated"
          Write-Host "Asset updated_at: $assetUpdated"

          # Download with no cache
          Invoke-WebRequest -Uri $downloadUrl -OutFile "zen.zip" -UseBasicParsing -Headers @{ "Cache-Control" = "no-cache" }

          # Debug: show downloaded file details
          $fileInfo = Get-Item "zen.zip"
          Write-Host "Downloaded zen.zip size: $($fileInfo.Length) bytes"
          Write-Host "Last write time: $($fileInfo.LastWriteTimeUtc)"

          echo "VERSION=$tagVersion" >> $env:GITHUB_ENV
          echo "PACKAGE_VERSION=$safeVer" >> $env:GITHUB_ENV
          echo "DISPLAY_VERSION=$displayName" >> $env:GITHUB_ENV
          echo "ASSET_UPDATED=$assetUpdated" >> $env:GITHUB_ENV

      - name: Check if upstream changed
        shell: powershell
        run: |
          $marker = ".github/last_upstream_asset_updated.txt"
          $lastUpdated = if (Test-Path $marker) { Get-Content $marker -Raw } else { "" }
          $currentUpdated = $env:ASSET_UPDATED

          Write-Host "Last known asset updated_at: $lastUpdated"
          Write-Host "Current asset updated_at: $currentUpdated"

          if ($currentUpdated -eq $lastUpdated) {
              Write-Host "No change in upstream Twilight asset. Skipping build."
              echo "SKIP_BUILD=true" >> $env:GITHUB_ENV
          } else {
              Write-Host "Upstream Twilight asset updated - proceeding with build."
              echo "SKIP_BUILD=false" >> $env:GITHUB_ENV

              # Update marker
              New-Item -ItemType Directory -Force -Path ".github" | Out-Null
              Set-Content -Path $marker -Value $currentUpdated -Force

              git config user.name "github-actions[bot]"
              git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
              git add $marker
              git commit -m "chore(ci): update last upstream asset timestamp to $currentUpdated" || {
                  Write-Host "Commit failed (no changes). Skipping push."
              }

              git push origin "HEAD:${{ github.ref_name }}" || {
                  Write-Host "Push failed. Continuing anyway."
              }
          }

      - name: Exit early if no change
        if: env.SKIP_BUILD == 'true'
        run: exit 0

      # ... (rest of your steps: Extract Zip, Configure App, Create Help File, Compile Launcher, Generate PAF Icons, Package to ZIP, Create and Upload Release with gh CLI remain the same)
