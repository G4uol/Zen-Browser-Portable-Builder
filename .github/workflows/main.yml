name: Build Zen Browser Portable

on:
  schedule:
    - cron: '0 6 * * *'   # 06:00 UTC daily
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find and Download Zip
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $url = "https://api.github.com/repos/zen-browser/desktop/releases/tags/twilight"
          $headers = @{ "Authorization" = "token $env:GH_TOKEN" }
          try {
              $release = Invoke-RestMethod -Uri $url -Method Get -Headers $headers
          } catch {
              Write-Error "API Error: $($_.Exception.Message)"
              exit 1
          }

          $downloadUrl = ""
          $tagVersion = $release.tag_name
          $displayName = $release.name
          $upstreamUpdated = $release.updated_at

          if ($displayName -match '(\d+\.\d+[a-z]?)') {
              $buildVer = $matches[1]
          } else {
              $buildVer = "0.0"
          }

          $safeVer = $buildVer -replace '[a-z]', ''
          while (($safeVer.ToCharArray() | Where-Object { $_ -eq '.' }).Count -lt 3) { $safeVer += ".0" }
          if ($safeVer.StartsWith('.')) { $safeVer = "0" + $safeVer }

          foreach ($asset in $release.assets) {
              if ($asset.name -eq "zen.win-x86_64.zip") {
                  $downloadUrl = $asset.browser_download_url
                  break
              }
          }

          if (-not $downloadUrl) {
              Write-Error "Target Not Found - checked for zen.win-x86_64.zip"
              exit 1
          }

          Write-Host "Target tag: $tagVersion, Build: $buildVer, Safe package version: $safeVer"
          Write-Host "Upstream updated_at: $upstreamUpdated"
          Invoke-WebRequest -Uri $downloadUrl -OutFile "zen.zip"

          echo "VERSION=$tagVersion" >> $env:GITHUB_ENV
          echo "PACKAGE_VERSION=$safeVer" >> $env:GITHUB_ENV
          echo "DISPLAY_VERSION=$displayName" >> $env:GITHUB_ENV
          echo "UPSTREAM_UPDATED=$upstreamUpdated" >> $env:GITHUB_ENV

      - name: Check if upstream changed
        shell: powershell
        run: |
          $marker = ".github/last_upstream_updated.txt"
          $lastUpdated = if (Test-Path $marker) { Get-Content $marker -Raw } else { "" }
          $currentUpdated = $env:UPSTREAM_UPDATED

          Write-Host "Last known upstream updated_at: $lastUpdated"
          Write-Host "Current upstream updated_at: $currentUpdated"

          if ($currentUpdated -eq $lastUpdated) {
              Write-Host "No change in upstream Twilight release. Skipping build."
              echo "SKIP_BUILD=true" >> $env:GITHUB_ENV
          } else {
              Write-Host "Upstream Twilight updated - proceeding with build."
              echo "SKIP_BUILD=false" >> $env:GITHUB_ENV

              # Update marker for next run
              New-Item -ItemType Directory -Force -Path ".github" | Out-Null
              Set-Content -Path $marker -Value $currentUpdated -Force

              git config user.name "github-actions[bot]"
              git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
              git add $marker
              git commit -m "chore(ci): update last upstream timestamp to $currentUpdated"

              if ($LASTEXITCODE -ne 0) {
                  Write-Host "Commit failed (no changes). Skipping push."
              } else {
                  git push origin "HEAD:${{ github.ref_name }}"
                  if ($LASTEXITCODE -ne 0) {
                      Write-Host "Push failed. Continuing anyway (marker update is local)."
                  }
              }
          }

      - name: Exit early if no change
        if: env.SKIP_BUILD == 'true'
        run: exit 0

      - name: Extract Zip
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "ZenBrowserPortable\App\ZenBrowser"
          New-Item -ItemType Directory -Force -Path "ZenBrowserPortable\App\AppInfo"
          New-Item -ItemType Directory -Force -Path "ZenBrowserPortable\Data"
          New-Item -ItemType Directory -Force -Path "ZenBrowserPortable\Other\Source"

          Expand-Archive -Path "zen.zip" -DestinationPath "temp_extract" -Force

          $zenRoot = Get-ChildItem -Path "temp_extract" -Recurse -File -Filter "zen.exe" -ErrorAction SilentlyContinue |
                     Select-Object -First 1 | ForEach-Object { $_.DirectoryName }

          if (-not $zenRoot) {
              Write-Error "zen.exe not found anywhere in extracted ZIP!"
              exit 1
          }

          Write-Host "Found zen.exe in: $zenRoot - moving contents to App\ZenBrowser"
          Copy-Item -Path "$zenRoot\*" -Destination "ZenBrowserPortable\App\ZenBrowser" -Recurse -Force
          Copy-Item -Path "$zenRoot\.*" -Destination "ZenBrowserPortable\App\ZenBrowser" -Force -ErrorAction SilentlyContinue

          Write-Host "Files now in App\ZenBrowser:"
          Get-ChildItem -Path "ZenBrowserPortable\App\ZenBrowser" -Recurse | Select-Object FullName

          Remove-Item -Path "temp_extract" -Recurse -Force -ErrorAction SilentlyContinue

      - name: Configure App
        shell: powershell
        run: |
          $distDir = "ZenBrowserPortable\App\ZenBrowser\distribution"
          New-Item -ItemType Directory -Force -Path $distDir
          Set-Content -Path "$distDir\policies.json" -Value '{ "policies": { "DisableAppUpdate": true, "ManualAppUpdateOnly": true } }'

          $packageVer = $env:PACKAGE_VERSION
          $displayVer = $env:DISPLAY_VERSION
          Set-Content -Path "ZenBrowserPortable\App\AppInfo\version.txt" -Value $displayVer

          $iniPath = "ZenBrowserPortable\App\AppInfo\appinfo.ini"
          $content = Get-Content "appinfo.ini" -Raw
          $content = $content -replace "PackageVersion=1.0.0.0", "PackageVersion=$packageVer"
          $content = $content -replace "DisplayVersion=Latest", "DisplayVersion=$displayVer"
          if ($content -notmatch '\[License\].*CommercialUse=true') {
              $content += "`r`n`r`n[License]`r`nCommercialUse=true"
          }
          Set-Content -Path $iniPath -Value $content -Encoding UTF8

      - name: Create Help File
        shell: powershell
        run: |
          Set-Content -Path "ZenBrowserPortable\help.html" -Value "<html><body><h1>Zen Browser Portable (Twilight)</h1><p>Built from Zen Twilight release.</p></body></html>"

      - name: Compile Launcher
        shell: cmd
        run: |
          copy appicon.ico ZenBrowserPortable\App\AppInfo\ >nul
          set CSC=%windir%\Microsoft.NET\Framework64\v4.0.30319\csc.exe
          "%CSC%" /target:exe /out:ZenBrowserPortable\ZenBrowserPortable.exe /win32icon:appicon.ico /r:System.Windows.Forms.dll Launcher.cs
          if %ERRORLEVEL% NEQ 0 (echo Launcher compilation failed & exit /b 1)

      - name: Generate PAF Icons
        shell: powershell
        run: |
          Add-Type -AssemblyName System.Drawing
          $icoPath = "appicon.ico"
          $destDir = "ZenBrowserPortable\App\AppInfo"
          if (-not (Test-Path $icoPath)) { Write-Error "appicon.ico missing!"; exit 1 }
          $icon = [System.Drawing.Icon]::ExtractAssociatedIcon($icoPath)
          $bmp = $icon.ToBitmap()
          foreach ($size in 16, 32, 128) {
              $resized = New-Object System.Drawing.Bitmap($bmp, $size, $size)
              $resized.Save("$destDir\appicon_$size.png", [System.Drawing.Imaging.ImageFormat]::Png)
          }
          Copy-Item $icoPath "$destDir\appicon.ico" -Force

      - name: Package to ZIP
        shell: powershell
        run: |
          $timestamp = Get-Date -Format "yyyyMMdd-HHmm"
          $displayVer = $env:DISPLAY_VERSION -replace '[^a-zA-Z0-9.-]', '_'
          $zipName = "ZenBrowserPortable_Twilight_${displayVer}_${timestamp}.zip"
          Write-Host "Creating ZIP: $zipName"
          Compress-Archive -Path "ZenBrowserPortable" -DestinationPath $zipName -Force
          echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV

      - name: Create and Upload Release with gh CLI
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $timestamp = Get-Date -Format "yyyyMMdd-HHmm"
          $tag = "twilight-${timestamp}"
          $title = "Zen Browser Portable Twilight - $($env:DISPLAY_VERSION)"
          $body = @"
          Automated portable build of the latest Zen Twilight release.

          - Upstream release: $($env:DISPLAY_VERSION)
          - Built on: $(Get-Date -Format "yyyy-MM-dd HH:mm UTC")
          - Portable launcher by G4uol
          - Updates disabled via policies.json
          - Extract and run ZenBrowserPortable.exe

          Always latest via daily schedule.
          "@
          gh release create $tag `
            --title $title `
            --notes $body `
            --target main `
            "$($env:ZIP_NAME)"
