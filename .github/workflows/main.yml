name: Build Zen Browser Portable

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 1. 下载 Zen Browser
    - name: Find and Download Installer
      shell: powershell
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $url = "https://api.github.com/repos/zen-browser/desktop/releases?per_page=5"
        $headers = @{ "Authorization" = "token $env:GH_TOKEN" }
        try {
            $releases = Invoke-RestMethod -Uri $url -Method Get -Headers $headers
        } catch {
            Write-Error "API Error: $($_.Exception.Message)"
            exit 1
        }

        $downloadUrl = ""
        $version = ""
        foreach ($release in $releases) {
            foreach ($asset in $release.assets) {
                if ($asset.name -eq "zen.installer.exe") {
                    $downloadUrl = $asset.browser_download_url
                    $version = $release.tag_name
                    break
                }
            }
            if ($downloadUrl) { break }
        }

        if (-not $downloadUrl) { Write-Error "Target Not Found"; exit 1 }
        Write-Host "Target: $version"
        Invoke-WebRequest -Uri $downloadUrl -OutFile "zen_installer.exe"
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT

    # 2. 解压 Zen Browser
    - name: Extract Installer
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "ZenBrowserPortable\App\ZenBrowser"
        New-Item -ItemType Directory -Force -Path "ZenBrowserPortable\App\AppInfo"
        New-Item -ItemType Directory -Force -Path "ZenBrowserPortable\Data"
        # 创建空目录消除 Warning
        New-Item -ItemType Directory -Force -Path "ZenBrowserPortable\Other\Source"
        
        7z x "zen_installer.exe" -o"TempExtract" -y
        if (Test-Path "TempExtract\core") {
            Move-Item "TempExtract\core\*" "ZenBrowserPortable\App\ZenBrowser"
        } else {
            $zenExe = Get-ChildItem -Path "TempExtract" -Filter "zen.exe" -Recurse | Select-Object -First 1
            if ($zenExe) { Move-Item "$($zenExe.DirectoryName)\*" "ZenBrowserPortable\App\ZenBrowser" }
        }

    # 3. 配置策略与版本
    - name: Configure App
      shell: powershell
      run: |
        $distDir = "ZenBrowserPortable\App\ZenBrowser\distribution"
        New-Item -ItemType Directory -Force -Path $distDir
        Set-Content -Path "$distDir\policies.json" -Value '{ "policies": { "DisableAppUpdate": true, "ManualAppUpdateOnly": true } }'

        $ver = "${{ steps.find_download.outputs.VERSION }}"
        if (-not $ver) { $ver = "${{ env.VERSION }}" }
        Set-Content -Path "ZenBrowserPortable\App\AppInfo\version.txt" -Value $ver

        $safeVer = $ver -replace "[^0-9.]", ""
        while (($safeVer.ToCharArray() | Where-Object { $_ -eq '.' }).Count -lt 3) { $safeVer += ".0" }
        
        $iniPath = "ZenBrowserPortable\App\AppInfo\appinfo.ini"
        $content = Get-Content "appinfo.ini"
        $content = $content -replace "PackageVersion=1.0.0.0", "PackageVersion=$safeVer"
        $content = $content -replace "DisplayVersion=Latest", "DisplayVersion=$ver"
        if ($content -notcontains "CommercialUse=true") {
            $content = $content -replace "\[License\]", "[License]`r`nCommercialUse=true"
        }
        Set-Content -Path $iniPath -Value $content

    # 4. 创建 help.html
    - name: Create Help File
      shell: powershell
      run: |
        Set-Content -Path "ZenBrowserPortable\help.html" -Value "<html><body><h1>Zen Browser Portable</h1></body></html>"

    # 5. 编译启动器
    - name: Compile Launcher
      shell: cmd
      run: |
        copy appicon.ico ZenBrowserPortable\App\AppInfo\
        set CSC=%windir%\Microsoft.NET\Framework64\v4.0.30319\csc.exe
        "%CSC%" /target:exe /out:ZenBrowserPortable\ZenBrowserPortable.exe /win32icon:appicon.ico /r:System.Windows.Forms.dll Launcher.cs

    # 6. 生成图标
    - name: Generate PAF Icons
      shell: powershell
      run: |
        Add-Type -AssemblyName System.Drawing
        $icoPath = "appicon.ico"
        $destDir = "ZenBrowserPortable\App\AppInfo"
        if (-not (Test-Path $icoPath)) { Write-Error "appicon.ico missing!"; exit 1 }
        $icon = [System.Drawing.Icon]::ExtractAssociatedIcon($icoPath)
        $bmp = $icon.ToBitmap()
        foreach ($size in 16, 32, 128) {
            $resized = new-object System.Drawing.Bitmap($bmp, $size, $size)
            $resized.Save("$destDir\appicon_$size.png", [System.Drawing.Imaging.ImageFormat]::Png)
        }
        Copy-Item $icoPath "$destDir\appicon.ico" -Force

    # 7. 解压并准备环境 (搬家到 C:\B 避开长路径)
    - name: Prepare Build Environment
      shell: powershell
      run: |
        if (-not (Test-Path "InstallerTool.zip")) { Write-Error "InstallerTool.zip missing!"; exit 1 }
        
        # 创建工作目录 C:\B
        New-Item -ItemType Directory -Force -Path "C:\B"
        
        # 解压工具到 C:\B\Tool
        7z x "InstallerTool.zip" -o"C:\B\Tool" -y
        
        # 移动 ZenBrowserPortable 到 C:\B\ZenBrowserPortable
        Move-Item "ZenBrowserPortable" "C:\B\ZenBrowserPortable"
        
        Write-Host "Files moved to C:\B"

    # === 8. 执行打包 (超时延长至 20 分钟) ===
    - name: Build .paf.exe Package
      shell: powershell
      run: |
        # 自动搜寻 exe
        $pafExe = Get-ChildItem -Path "C:\B\Tool" -Filter "PortableApps.comInstaller.exe" -Recurse | Select-Object -First 1
        
        if (-not $pafExe) { 
            Write-Error "FATAL: InstallerTool EXE not found!"
            exit 1 
        }
        
        $builderPath = $pafExe.FullName
        $sourcePath = "C:\B\ZenBrowserPortable"
        
        Write-Host "Builder: $builderPath"
        Write-Host "Source:  $sourcePath"
        
        # 启动进程
        # Timeout 改为 1200秒 (20分钟)，给 GitHub 弱鸡服务器充足的时间
        $p = Start-Process -FilePath $builderPath -ArgumentList "`"$sourcePath`"" -PassThru
        
        try {
            $p | Wait-Process -Timeout 1200
            Write-Host "PAF Build finished successfully."
        } catch {
            $p | Stop-Process -Force
            Write-Warning "PAF Build TIMED OUT (20min)! Killing process."
            Write-Warning "Continuing to ZIP upload..."
        }

    # 9. 搬回文件并上传
    - name: Finalize Packages
      shell: powershell
      run: |
        $ver = Get-Content "C:\B\ZenBrowserPortable\App\AppInfo\version.txt"
        
        # 找回生成的 .paf.exe
        $pafFile = Get-ChildItem -Path "C:\B" -Filter "*.paf.exe" | Select-Object -First 1
        if ($pafFile) { 
            # 搬回工作目录
            Move-Item $pafFile.FullName ".\ZenBrowserPortable_${ver}.paf.exe"
            Write-Host "SUCCESS: Installer recovered."
        }
        
        # 打包 ZIP (从 C:\B 压缩)
        Compress-Archive -Path "C:\B\ZenBrowserPortable" -DestinationPath "ZenBrowserPortable_${ver}.zip"

    # 10. 上传
    - name: Upload Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: Zen Browser Portable ${{ env.VERSION }}
        files: |
          *.zip
          *.paf.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
